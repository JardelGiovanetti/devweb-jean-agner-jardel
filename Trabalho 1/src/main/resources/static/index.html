<!DOCTYPE html>
<html>

<head>
    <title>CRUD de Produtos</title>
</head>

<body>
    <h1>CRUD de Produtos</h1>

    <!-- Formulário para adicionar um produto -->
    <h2>Adicionar Produto</h2>
    <form id="formAdicionarProduto">
        <label for="codigo">Código:</label>
        <input type="text" id="codigo" name="codigo" required><br><br>

        <label for="descricao">Descrição:</label>
        <input type="text" id="descricao" name="descricao" required><br><br>

        <label for="valor_custo">Valor de Custo:</label>
        <input type="number" id="valor_custo" name="valor_custo" step="0.01" required><br><br>

        <label for="valor_venda">Valor de Venda:</label>
        <input type="number" id="valor_venda" name="valor_venda" step="0.01" required><br><br>

        <button type="submit">Adicionar</button>
    </form>

    <!-- Tabela para listar os produtos -->
    <h2>Lista de Produtos</h2>
    <table id="tabelaProdutos">
        <thead>
            <tr>
                <th>Código</th>
                <th>Descrição</th>
                <th>Valor de Custo</th>
                <th>Valor de Venda</th>
                <th>Ações</th>
            </tr>
        </thead>
        <tbody>
            <!-- Os produtos serão listados aqui -->
        </tbody>
    </table>

    <script>
        // Função para carregar a lista de produtos ao carregar a página
        window.onload = function () {
            carregarProdutos();
        };

        // Função para carregar a lista de produtos
        function carregarProdutos() {
            fetch('/produto')
                .then(response => response.json())
                .then(produtos => {
                    const tabelaProdutos = document.getElementById('tabelaProdutos');
                    const tbody = tabelaProdutos.getElementsByTagName('tbody')[0];
                    tbody.innerHTML = '';
                    produtos.forEach(produto => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${produto.codigo}</td>
                            <td>${produto.descricao}</td>
                            <td>${produto.valor_custo}</td>
                            <td>${produto.valor_venda}</td>
                            <td>
                                <button onclick="editarProduto(${produto.id_produto})">Editar</button>
                                <button onclick="excluirProduto(${produto.id_produto})">Excluir</button>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                });
        }

        // Função para adicionar um novo produto
        document.getElementById('formAdicionarProduto').addEventListener('submit', function (event) {
            event.preventDefault();

            const codigo = document.getElementById('codigo').value;
            const descricao = document.getElementById('descricao').value;
            const valor_custo = parseFloat(document.getElementById('valor_custo').value);
            const valor_venda = parseFloat(document.getElementById('valor_venda').value);

            const produto = {
                codigo: codigo,
                descricao: descricao,
                valor_custo: valor_custo,
                valor_venda: valor_venda
            };

            fetch('/produto/add', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(produto)
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Erro ao adicionar produto');
                    }
                    carregarProdutos();
                })
                .catch(error => {
                    console.error('Erro:', error);
                });
        });

        // Função para excluir um produto
        function excluirProduto(id_produto) {
            if (confirm('Deseja realmente excluir o produto?')) {
                fetch(`/produto/delete/${id_produto}`, {
                    method: 'DELETE'
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Erro ao excluir produto');
                        }
                        carregarProdutos();
                    })
                    .catch(error => {
                        console.error('Erro:', error);
                    });
            }
        }


        // Função para editar um produto
        function editarProduto(id_produto) {
            fetch(`/produto/get?id_produto=${id_produto}`)
                .then(response => response.json())
                .then(produto => {
                    document.getElementById('codigo').value = produto.codigo;
                    document.getElementById('descricao').value = produto.descricao;
                    document.getElementById('valor_custo').value = produto.valor_custo;
                    document.getElementById('valor_venda').value = produto.valor_venda;

                    // Altera o evento de submit para enviar a requisição PATCH
                    document.getElementById('formAdicionarProduto').onsubmit = function (event) {
                        event.preventDefault();

                        const codigo = document.getElementById('codigo').value;
                        const descricao = document.getElementById('descricao').value;
                        const valor_custo = parseFloat(document.getElementById('valor_custo').value);
                        const valor_venda = parseFloat(document.getElementById('valor_venda').value);

                        const produtoAtualizado = {
                            codigo: codigo,
                            descricao: descricao,
                            valor_custo: valor_custo,
                            valor_venda: valor_venda
                        };

                        fetch(`/produto/update/${id_produto}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(produtoAtualizado)
                        })
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error('Erro ao atualizar produto');
                                }
                                carregarProdutos();
                            })
                            .catch(error => {
                                console.error('Erro:', error);
                            });
                    };
                })
                .catch(error => {
                    console.error('Erro:', error);
                });
        }

    </script>
</body>

</html>